# Setup SSHD

- name: Disable root login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*PermitRootLogin .+$'
    line: 'PermitRootLogin no'
    validate: 'sshd -t -f %s'
  notify: Restart SSHD

- name: Enable password login
  when: 'linux_server_sshd_password_auth_enable'
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*PasswordAuthentication .+$'
    line: 'PasswordAuthentication yes'
    validate: 'sshd -t -f %s'
  notify: Restart SSHD

- name: Disable password login
  when: 'not linux_server_sshd_password_auth_enable'
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*PasswordAuthentication .+$'
    line: 'PasswordAuthentication no'
    validate: 'sshd -t -f %s'
  notify: Restart SSHD

# Disable locales to avoid annoying missing locale errors
- name: Disable SSH user locales
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*AcceptEnv LANG LC_\*$'
    line: '#AcceptEnv LANG LC_*'
    validate: 'sshd -t -f %s'
  notify: Restart SSHD

- name: Set banner location
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?\s*Banner .+$'
    line: 'Banner /etc/issue.net'
    validate: 'sshd -t -f %s'
  notify: Restart SSHD
